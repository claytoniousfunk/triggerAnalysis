#include "/home/clayton/Analysis/code/bJetMuonTaggingAnalysis/headers/functions/getDr.h"

using namespace std;

TH1D *h_dr = new TH1D("h_dr","h_dr",100,0,1);
TH2D *H_hlt_forest_pt = new TH2D("H_hlt_forest_pt","hlt pt vs gen forest pt",500,0,5,500,0,500);

Float_t ptMin = 0.;
Float_t ptMax = 300.;
Int_t NPtBins = 30;

Float_t etaMin = -5.0;
Float_t etaMax = 5.0;
Float_t NEtaBins = 100;

Float_t phiMin = -TMath::Pi();
Float_t phiMax = TMath::Pi();
Float_t NPhiBins = 100;

TH1D *denom = new TH1D("denom","denom",NPtBins,ptMin,ptMax);
TH1D *denomEta_40 = new TH1D("denomEta_40","denomEta_40",NEtaBins,etaMin,etaMax);
TH1D *denomEta_60 = new TH1D("denomEta_60","denomEta_60",NEtaBins,etaMin,etaMax);
TH1D *denomEta_80 = new TH1D("denomEta_80","denomEta_80",NEtaBins,etaMin,etaMax);
TH1D *denomEta_100 = new TH1D("denomEta_100","denomEta_100",NEtaBins,etaMin,etaMax);
TH1D *denomEta_120 = new TH1D("denomEta_120","denomEta_120",NEtaBins,etaMin,etaMax);
TH1D *denomPhi_40 = new TH1D("denomPhi_40","denomPhi_40",NPhiBins,phiMin,phiMax);
TH1D *denomPhi_60 = new TH1D("denomPhi_60","denomPhi_60",NPhiBins,phiMin,phiMax);
TH1D *denomPhi_80 = new TH1D("denomPhi_80","denomPhi_80",NPhiBins,phiMin,phiMax);
TH1D *denomPhi_100 = new TH1D("denomPhi_100","denomPhi_100",NPhiBins,phiMin,phiMax);
TH1D *denomPhi_120 = new TH1D("denomPhi_120","denomPhi_120",NPhiBins,phiMin,phiMax);

TH1D *num_40 = new TH1D("num_40","num_40",NPtBins,ptMin,ptMax);
TH1D *numEta_40 = new TH1D("numEta_40","numEta_40",NEtaBins,etaMin,etaMax);
TH1D *numPhi_40 = new TH1D("numPhi_40","numPhi_40",NPhiBins,phiMin,phiMax);
TH1D *r_40 = new TH1D("r_40","r_40",NPtBins,ptMin,ptMax);

TH1D *num_60 = new TH1D("num_60","num_60",NPtBins,ptMin,ptMax);
TH1D *numEta_60 = new TH1D("numEta_60","numEta_60",NEtaBins,etaMin,etaMax);
TH1D *numPhi_60 = new TH1D("numPhi_60","numPhi_60",NPhiBins,phiMin,phiMax);
TH1D *r_60 = new TH1D("r_60","r_60",NPtBins,ptMin,ptMax);

TH1D *num_80 = new TH1D("num_80","num_80",NPtBins,ptMin,ptMax);
TH1D *numEta_80 = new TH1D("numEta_80","numEta_80",NEtaBins,etaMin,etaMax);
TH1D *numPhi_80 = new TH1D("numPhi_80","numPhi_80",NPhiBins,phiMin,phiMax);
TH1D *r_80 = new TH1D("r_80","r_80",NPtBins,ptMin,ptMax);

TH1D *num_100 = new TH1D("num_100","num_100",NPtBins,ptMin,ptMax);
TH1D *numEta_100 = new TH1D("numEta_100","numEta_100",NEtaBins,etaMin,etaMax);
TH1D *numPhi_100 = new TH1D("numPhi_100","numPhi_100",NPhiBins,phiMin,phiMax);
TH1D *r_100 = new TH1D("r_100","r_100",NPtBins,ptMin,ptMax);

TH1D *num_120 = new TH1D("num_120","num_120",NPtBins,ptMin,ptMax);
TH1D *numEta_120 = new TH1D("numEta_120","numEta_120",NEtaBins,etaMin,etaMax);
TH1D *numPhi_120 = new TH1D("numPhi_120","numPhi_120",NPhiBins,phiMin,phiMax);
TH1D *r_120 = new TH1D("r_120","r_120",NPtBins,ptMin,ptMax);



std::map<unsigned long long, int> runLumiEvtToEntryMap;



unsigned long long keyFromRunLumiEvent(Int_t run,
                                       Int_t lumi,
                                       ULong64_t event)
{
  const unsigned long long runMult = 1;
  const unsigned long long lumiMult = 1000000;
  const unsigned long long evtMult = 10000000000;
  const unsigned long long evtLimit = 10000000000;

  unsigned long long key = 0;
  if(event >= evtLimit){
    std::cout << "RUNLUMIEVENTKEY WARNING : \'" << event
              << "\' is greated that event limit 10^10. returning key 0"
              << std::endl;
    return key;
  }

  key += runMult* static_cast<unsigned long long>(run);
  key += lumiMult*static_cast<unsigned long long>(lumi);
  key += evtMult*event;

  //std::cout << "key = " << key << std::endl;
  
  return key;
  
}





void jetAnalysis(std::string triggerFile = "/home/clayton/Analysis/code/HLTAnalysis/rootFiles/openHLT_pp_DiJet_JEC_newGT.root",
                           std::string inputFile = "/home/clayton/Analysis/code/HLTAnalysis/rootFiles/HiForestMiniAOD_newCaloParams.root",
                           std::string outputFile = "out.root"){

    std::cout << "running triggerAnalysis()" << std::endl;
    std::cout << "inputFile   = " << inputFile.c_str()  << std::endl;
    std::cout << "outputFile  = " << outputFile.c_str() << std::endl;	


    std::cout << "### input file ###" << std::endl; 
    TFile* input = TFile::Open(inputFile.c_str(), "READ");


    TTree* treeggHiNtuplizer = 0;
    TTree* treeJet = 0;
    TTree* treeHLTJet = 0;
    TTree* treeHiEvt = 0;
    TTree* treeTrig = 0;
        
    TFile* fileTmp = 0;
    TFile* fileTrig = 0;
    
    std::cout << "### HLT bit analysis file ###" << std::endl;
    fileTrig = TFile::Open(triggerFile.c_str(), "READ");
    fileTrig->cd();

    std::string treeHLTJetPath = "hltobject/HLT_AK4PFJet40_v";
    treeHLTJet = (TTree*) fileTrig->Get(treeHLTJetPath.c_str());
    treeHLTJet->SetBranchStatus("*",0);
    treeHLTJet->SetBranchStatus("pt",1);
    treeHLTJet->SetBranchStatus("eta",1);
    treeHLTJet->SetBranchStatus("phi",1);
    
    std::string treeTrigPath = "hltanalysis/HltTree";
    treeTrig = (TTree*)fileTrig->Get(treeTrigPath.c_str());
    treeTrig->SetBranchStatus("*",0);     // disable all branches



    // specify explicitly which branches to use
    treeTrig->SetBranchStatus("Event", 1);
    treeTrig->SetBranchStatus("LumiBlock", 1);
    treeTrig->SetBranchStatus("Run", 1);
   
    treeTrig->SetBranchStatus("HLT_AK4PFJet40_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJet60_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJet80_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJet100_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJet120_v", 1);
    
    treeTrig->SetBranchStatus("HLT_AK4PFJet40_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJet60_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJet80_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJet100_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJet120_noL1Seed_v", 1);

    treeTrig->SetBranchStatus("HLT_AK4PFJetFwd40_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJetFwd60_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJetFwd80_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJetFwd100_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJetFwd120_v", 1);
    
    treeTrig->SetBranchStatus("HLT_AK4PFJetFwd40_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJetFwd60_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJetFwd80_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJetFwd100_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4PFJetFwd120_noL1Seed_v", 1);
    
    treeTrig->SetBranchStatus("HLT_AK4CaloJet40_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJet60_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJet70_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJet100_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJet120_v", 1);
    
    treeTrig->SetBranchStatus("HLT_AK4CaloJet40_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJet60_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJet70_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJet100_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJet120_noL1Seed_v", 1);

    treeTrig->SetBranchStatus("HLT_AK4CaloJetFwd40_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJetFwd60_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJetFwd70_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJetFwd100_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJetFwd120_v", 1);
    
    treeTrig->SetBranchStatus("HLT_AK4CaloJetFwd40_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJetFwd60_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJetFwd70_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJetFwd100_noL1Seed_v", 1);
    treeTrig->SetBranchStatus("HLT_AK4CaloJetFwd120_noL1Seed_v", 1);
    
    //Int_t hlt_event;
    ULong64_t       hlt_event;
    Int_t           hlt_lumi;
    Int_t           hlt_run;
    Bool_t          triggerDecision_40;
    Bool_t          triggerDecision_60;
    Bool_t          triggerDecision_80;
    Bool_t          triggerDecision_100;
    Bool_t          triggerDecision_120;
    std::cout << "Setting Event, lumi, and run branchAdresses...";
    treeTrig->SetBranchAddress("Event", &hlt_event);
    treeTrig->SetBranchAddress("LumiBlock", &hlt_lumi);
    treeTrig->SetBranchAddress("Run", &hlt_run);
    
    // treeTrig->SetBranchAddress("HLT_AK4PFJetFwd40_v",&triggerDecision_40);
    // treeTrig->SetBranchAddress("HLT_AK4PFJetFwd60_v",&triggerDecision_60);
    // treeTrig->SetBranchAddress("HLT_AK4PFJetFwd80_v",&triggerDecision_80);
    // treeTrig->SetBranchAddress("HLT_AK4PFJetFwd100_v",&triggerDecision_100);
    // treeTrig->SetBranchAddress("HLT_AK4PFJetFwd120_v",&triggerDecision_120);

    // treeTrig->SetBranchAddress("HLT_AK4PFJetFwd40_noL1Seed_v",&triggerDecision_40);
    // treeTrig->SetBranchAddress("HLT_AK4PFJetFwd60_noL1Seed_v",&triggerDecision_60);
    // treeTrig->SetBranchAddress("HLT_AK4PFJetFwd80_noL1Seed_v",&triggerDecision_80);
    // treeTrig->SetBranchAddress("HLT_AK4PFJetFwd100_noL1Seed_v",&triggerDecision_100);
    // treeTrig->SetBranchAddress("HLT_AK4PFJetFwd120_noL1Seed_v",&triggerDecision_120);
    
    // treeTrig->SetBranchAddress("HLT_AK4PFJet40_v",&triggerDecision_40);
    // treeTrig->SetBranchAddress("HLT_AK4PFJet60_v",&triggerDecision_60);
    // treeTrig->SetBranchAddress("HLT_AK4PFJet80_v",&triggerDecision_80);
    // treeTrig->SetBranchAddress("HLT_AK4PFJet100_v",&triggerDecision_100);
    // treeTrig->SetBranchAddress("HLT_AK4PFJet120_v",&triggerDecision_120);
     
    // treeTrig->SetBranchAddress("HLT_AK4PFJet40_noL1Seed_v",&triggerDecision_40);
    // treeTrig->SetBranchAddress("HLT_AK4PFJet60_noL1Seed_v",&triggerDecision_60);
    // treeTrig->SetBranchAddress("HLT_AK4PFJet80_noL1Seed_v",&triggerDecision_80);
    // treeTrig->SetBranchAddress("HLT_AK4PFJet100_noL1Seed_v",&triggerDecision_100);
    // treeTrig->SetBranchAddress("HLT_AK4PFJet120_noL1Seed_v",&triggerDecision_120);
    
    treeTrig->SetBranchAddress("HLT_AK4CaloJet40_v",&triggerDecision_40);
    treeTrig->SetBranchAddress("HLT_AK4CaloJet60_v",&triggerDecision_60);
    treeTrig->SetBranchAddress("HLT_AK4CaloJet70_v",&triggerDecision_80);
    treeTrig->SetBranchAddress("HLT_AK4CaloJet100_v",&triggerDecision_100);
    treeTrig->SetBranchAddress("HLT_AK4CaloJet120_v",&triggerDecision_120);
    
    //treeTrig->SetBranchAddress("HLT_AK4CaloJet40_noL1Seed_v",&triggerDecision_40);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJet60_noL1Seed_v",&triggerDecision_60);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJet70_noL1Seed_v",&triggerDecision_80);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJet100_noL1Seed_v",&triggerDecision_100);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJet120_noL1Seed_v",&triggerDecision_120);

    // treeTrig->SetBranchAddress("HLT_AK4CaloJetFwd40_v",&triggerDecision_40);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJetFwd60_v",&triggerDecision_60);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJetFwd70_v",&triggerDecision_80);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJetFwd100_v",&triggerDecision_100);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJetFwd120_v",&triggerDecision_120);
    
    // treeTrig->SetBranchAddress("HLT_AK4CaloJetFwd40_noL1Seed_v",&triggerDecision_40);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJetFwd60_noL1Seed_v",&triggerDecision_60);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJetFwd70_noL1Seed_v",&triggerDecision_80);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJetFwd100_noL1Seed_v",&triggerDecision_100);
    // treeTrig->SetBranchAddress("HLT_AK4CaloJetFwd120_noL1Seed_v",&triggerDecision_120);
    

    
    std::cout << "done" << std::endl;

    std::cout << "get number of entries from HLT file..." << std::endl;

    Long64_t entriesHLT = treeTrig->GetEntries();
    std::cout << "HLT entries = " << entriesHLT << std::endl;
    
    std::cout << "get number of entries from reco file.." << std::endl;
    // read the first file only to get the HiForest info
    std::string inputPath = inputFile.c_str();
    fileTmp = TFile::Open(inputPath.c_str(), "READ");
    fileTmp->cd();


    std::string treePath = "ggHiNtuplizer/EventTree";

    // read one tree only to get the number of entries
    treeggHiNtuplizer = (TTree*)fileTmp->Get(treePath.c_str());
    Long64_t entriesTmp = treeggHiNtuplizer->GetEntries();
    std::cout << "reco entries = " << entriesTmp << std::endl;
 //   treeggHiNtuplizer->Delete();

 //   treeggHiNtuplizer = (TTree*)fileTmp->Get(treePath.c_str());
    treeggHiNtuplizer->SetBranchStatus("*",0);     // disable all branches
    
    std::map<unsigned long long, int> runLumiEvtToEntryMap;
    
    treeJet = (TTree*)fileTmp->Get("ak4PFJetAnalyzer/t");
    treeJet->SetBranchStatus("*",0);     // disable all branches
    treeJet->SetBranchStatus("jtpt",1);   // enable event information
    treeJet->SetBranchStatus("jteta",1);
    treeJet->SetBranchStatus("jtphi",1);
    treeJet->SetBranchStatus("genpt",1);   // enable event information
    treeJet->SetBranchStatus("geneta",1);
    treeJet->SetBranchStatus("genphi",1);
    treeJet->SetBranchStatus("nref",1);

    const unsigned int maxJets = 10000;
    
    Float_t jtpt[maxJets];
    Float_t jteta[maxJets];
    Float_t jtphi[maxJets];
    Float_t genjtpt[maxJets];
    Float_t genjteta[maxJets];
    Float_t genjtphi[maxJets];
    Int_t nref;

    treeJet->SetBranchAddress("jtpt",&jtpt);
    treeJet->SetBranchAddress("jteta",&jteta);
    treeJet->SetBranchAddress("jtphi",&jtphi);
    treeJet->SetBranchAddress("genpt",&genjtpt);
    treeJet->SetBranchAddress("geneta",&genjteta);
    treeJet->SetBranchAddress("genphi",&genjtphi);
    treeJet->SetBranchAddress("nref",&nref);

    std::vector<Float_t> *jtpt_hlt=0;
    std::vector<Float_t> *jteta_hlt=0;
    std::vector<Float_t> *jtphi_hlt=0;

    treeHLTJet->SetBranchAddress("pt",&jtpt_hlt);
    treeHLTJet->SetBranchAddress("eta",&jteta_hlt);
    treeHLTJet->SetBranchAddress("phi",&jtphi_hlt);
        
    treeHiEvt = (TTree*)fileTmp->Get("hiEvtAnalyzer/HiTree");
    treeHiEvt->SetBranchStatus("*",0);     // disable all branches
    treeHiEvt->SetBranchStatus("run",1);   // enable event information
    treeHiEvt->SetBranchStatus("evt",1);
    treeHiEvt->SetBranchStatus("lumi",1);
    treeHiEvt->SetBranchStatus("vz",1);
    treeHiEvt->SetBranchStatus("hiBin",1);
    treeHiEvt->SetBranchStatus("weight",1);

    Float_t vz;
    Int_t hiBin;
    UInt_t run;
    UInt_t lumi;
    ULong64_t evt;
    Float_t weight;

    treeHiEvt->SetBranchAddress("vz",&vz);
    treeHiEvt->SetBranchAddress("hiBin",&hiBin);
    treeHiEvt->SetBranchAddress("run",&run);
    treeHiEvt->SetBranchAddress("lumi",&lumi);
    treeHiEvt->SetBranchAddress("evt",&evt);
    treeHiEvt->SetBranchAddress("weight",&weight);
    
    // loop through HLT and create a key for each event
   

    for(Long64_t i_entry = 0; i_entry < entriesHLT; i_entry++){

       treeTrig->GetEntry(i_entry);
       unsigned long long key = keyFromRunLumiEvent(hlt_run, hlt_lumi, hlt_event);
       runLumiEvtToEntryMap[key] = i_entry;

    }




    // loop through reco objects
    for (Long64_t j_entry = 0; j_entry < entriesTmp; ++j_entry){

        treeggHiNtuplizer->GetEntry(j_entry);
        treeHiEvt->GetEntry(j_entry);
        treeJet->GetEntry(j_entry);

	//cout << "weight = " << weight << endl;
  	
	// event cuts
	if(fabs(vz)>15.0) continue;
        //if(hiBin>180) continue;	
       
        auto j_entry_status = treeJet->GetEntry(j_entry);
        
        if(j_entry_status < 0) {
            std::cout << Form("bad entry %lld in jet tree",j_entry) << std::endl;
            continue;
        }
	
        unsigned long long key = keyFromRunLumiEvent(run,lumi,evt);

        long long i_entry = -1;
        
        if(runLumiEvtToEntryMap.count(key) == 0) continue; // skip reco event if there is no HLT event match
        else i_entry = runLumiEvtToEntryMap.at(key);

        //std::cout << "i_entry = " << i_entry << std::endl;

	


	
        // now fill the denominator
        Float_t maxPt_denom = 0;
        Float_t maxEta_denom = 0;
	Float_t maxPhi_denom = 0;
        
        for(Int_t i_jet = 0; i_jet < nref; i_jet++){

	   	    
            if(jtpt[i_jet] > maxPt_denom) { // find the leading jetPt in the event, regardless of trigger.
                maxPt_denom = jtpt[i_jet];
                maxEta_denom = jteta[i_jet];
		maxPhi_denom = jtphi[i_jet];
		
            }

	}

        //if(fabs(maxEta_denom)<3.2 || fabs(maxEta_denom)>4.7) continue; // skip event if the leading jet is outside eta range
        if(fabs(maxEta_denom)>3.0) continue; // skip event if the leading jet is outside eta range

	    if(maxPt_denom > 0) {
            
            denom->Fill(maxPt_denom,weight);
	    if(maxPt_denom > 30){
	      denomEta_40->Fill(maxEta_denom,weight);
	      if(fabs(maxEta_denom) < 5.0){
		denomPhi_40->Fill(maxPhi_denom,weight);
	      }
	    }
	    if(maxPt_denom > 50){
	      denomEta_60->Fill(maxEta_denom,weight);
	      if(fabs(maxEta_denom) < 5.0){
		denomPhi_60->Fill(maxPhi_denom,weight);
	      }
	    }
	    if(maxPt_denom > 60){
	      denomEta_80->Fill(maxEta_denom,weight);
	      if(fabs(maxEta_denom) < 5.0){
		denomPhi_80->Fill(maxPhi_denom,weight);
	      }
	    }
	    if(maxPt_denom > 90){
	      denomEta_100->Fill(maxEta_denom,weight);
	      if(fabs(maxEta_denom) < 5.0){
		denomPhi_100->Fill(maxPhi_denom,weight);
	      }
	    }
	    if(maxPt_denom > 110.0){
	      denomEta_120->Fill(maxEta_denom,weight);
	      if(fabs(maxEta_denom) < 5.0){
		denomPhi_120->Fill(maxPhi_denom,weight);
	      }
	    }
	    
            //std::cout << "maxPt = " << maxPt_denom <<std::endl;
        }





        treeTrig->GetEntry(i_entry); // get trigger decision from HLT emulation
	treeHLTJet->GetEntry(i_entry);

	

	


	if(triggerDecision_40) {// only fill the numerator if the trigger is on.

	  cout << "evt: " << i_entry << endl;
	  
	  for(int z = 0; z < jtpt_hlt->size(); z++){

	    double hlt_pt = jtpt_hlt->at(z);
	    double hlt_eta = jteta_hlt->at(z);
	    double hlt_phi = jtphi_hlt->at(z);

	    double forest_match_pt = 0.0;
	    double forest_match_eta = 0.0;
	    double forest_match_phi = 0.0;
	    
	    double hlt_match_dr = 100.0;
	    bool hlt_is_matched = false;

	    cout << "--- Jet #" << z << ": (" << hlt_pt << ", " << hlt_eta << ", " << hlt_phi << ") " << endl;

	    for(int y = 0; y < nref; y++){

	      double forest_pt = genjtpt[y];
	      double forest_eta = genjteta[y];
	      double forest_phi = genjtphi[y];
	      
	      double hlt_forest_dr = getDr(hlt_eta,hlt_phi,forest_eta,forest_phi);

	      if(hlt_forest_dr < hlt_match_dr){
		hlt_match_dr = hlt_forest_dr;
		forest_match_pt = forest_pt;
		forest_match_eta = forest_eta;
		forest_match_phi = forest_phi;
	      }

	      

	    }

	    h_dr->Fill(hlt_match_dr,weight);
	    if(hlt_match_dr < 0.3){
	      H_hlt_forest_pt->Fill(hlt_pt/forest_match_pt,forest_match_pt,weight);
	    }
	    

	  }
	  

	  

            Float_t maxPt_num = 0;
	    Float_t maxEta_num = 0;
	    Float_t maxPhi_num = 0;
            
            // now fill the numerator
            for(Int_t i_jet = 0; i_jet < nref; i_jet++){

                // no eta cut needed since already applied after the first jet loop.  

                if(jtpt[i_jet] > maxPt_num) { // find the leading jetPt in events with trigger on.
                    maxPt_num = jtpt[i_jet];
		    maxEta_num = jteta[i_jet];
		    maxPhi_num = jtphi[i_jet];
                }


            }

            if(maxPt_num > 0){

                num_40->Fill(maxPt_num,weight);
		if(maxPt_num > 30){
		  numEta_40->Fill(maxEta_num,weight);
		  if(fabs(maxEta_num) < 5.0){
		    numPhi_40->Fill(maxPhi_num,weight);
		  }
		}
		
                //std::cout << "maxPt_num = " << maxPt_num << std::endl <<  std::endl;
            } 

        }

        
        
        if(triggerDecision_60) {// only fill the numerator if the trigger is on.

            Float_t maxPt_num = 0;
	    Float_t maxEta_num = 0;
	    Float_t maxPhi_num = 0;
            
            // now fill the numerator
            for(Int_t i_jet = 0; i_jet < nref; i_jet++){

                // no eta cut needed since already applied after the first jet loop.  

                if(jtpt[i_jet] > maxPt_num) { // find the leading jetPt in events with trigger on.
                    maxPt_num = jtpt[i_jet];
		    maxEta_num = jteta[i_jet];
		    maxPhi_num = jtphi[i_jet];
                }


            }

            if(maxPt_num > 0){

                num_60->Fill(maxPt_num,weight);
		if(maxPt_num > 50){
		  numEta_60->Fill(maxEta_num,weight);
		  if(fabs(maxEta_num) < 5.0){
		    numPhi_60->Fill(maxPhi_num,weight);
		  }
		}
                //std::cout << "maxPt_num = " << maxPt_num << std::endl <<  std::endl;
            } 

        }

	
	//cout << "--- CaloJet80 Jets ---" << endl;

        if(triggerDecision_80) {// only fill the numerator if the trigger is on.

	    Float_t maxPt_num = 0;
	    Float_t maxEta_num = 0;
	    Float_t maxPhi_num = 0;
            
            // now fill the numerator
            for(Int_t i_jet = 0; i_jet < nref; i_jet++){

                // no eta cut needed since already applied after the first jet loop.  
		    
	       // cout << "(jtpt, jteta, jtphi) = (" << jtpt[i_jet] << ", " << jteta[i_jet] << ", " << jtphi[i_jet] << ")" << endl;
		    
		if(jtpt[i_jet] > maxPt_num) { // find the leading jetPt in events with trigger on.
                    maxPt_num = jtpt[i_jet];
		    maxEta_num = jteta[i_jet];
		    maxPhi_num = jtphi[i_jet];
                }
                


            }

            if(maxPt_num > 0){

                num_80->Fill(maxPt_num,weight);
		if(maxPt_num > 60){
		  numEta_80->Fill(maxEta_num,weight);
		  if(fabs(maxEta_num) < 5.0){
		    numPhi_80->Fill(maxPhi_num,weight);
		  }
		}
                //std::cout << "maxPt_num = " << maxPt_num << std::endl <<  std::endl;
            } 

        }


	//cout << "--- CaloJet100 Jets ---" << endl;
		
        if(triggerDecision_100) {// only fill the numerator if the trigger is on.

            Float_t maxPt_num = 0;
	    Float_t maxEta_num = 0;
	    Float_t maxPhi_num = 0;
            
            // now fill the numerator
            for(Int_t i_jet = 0; i_jet < nref; i_jet++){


		//cout << "(jtpt, jteta, jtphi) = (" << jtpt[i_jet] << ", " << jteta[i_jet] << ", " << jtphi[i_jet] << ")" << endl;

                // no eta cut needed since already applied after the first jet loop.  

                if(jtpt[i_jet] > maxPt_num) { // find the leading jetPt in events with trigger on.
                    maxPt_num = jtpt[i_jet];
		    maxEta_num = jteta[i_jet];
		    maxPhi_num = jtphi[i_jet];
                }


            }

            if(maxPt_num > 0){

                num_100->Fill(maxPt_num,weight);
		if(maxPt_num > 90){
		  numEta_100->Fill(maxEta_num,weight);
		  if(fabs(maxEta_num) < 5.0){
		    numPhi_100->Fill(maxPhi_num,weight);
		  }
		}
                //std::cout << "maxPt_num = " << maxPt_num << std::endl <<  std::endl;
            } 

        }

        if(triggerDecision_120) {// only fill the numerator if the trigger is on.

            Float_t maxPt_num = 0;
	    Float_t maxEta_num = 0;
	    Float_t maxPhi_num = 0;
            
            // now fill the numerator
            for(Int_t i_jet = 0; i_jet < nref; i_jet++){

                // no eta cut needed since already applied after the first jet loop.  

                if(jtpt[i_jet] > maxPt_num) { // find the leading jetPt in events with trigger on.
                    maxPt_num = jtpt[i_jet];
		    maxEta_num = jteta[i_jet];
		    maxPhi_num = jtphi[i_jet];
                }


            }

            if(maxPt_num > 0){

                num_120->Fill(maxPt_num,weight);
		if(maxPt_num > 110.0){
		  numEta_120->Fill(maxEta_num,weight);
		  if(fabs(maxEta_num) < 5.0){
		    numPhi_120->Fill(maxPhi_num,weight);
		  }
		}
                //std::cout << "maxPt_num = " << maxPt_num << std::endl <<  std::endl;
            } 

        }




    }

    r_40->Divide(num_40,denom,1,1,"B");
    r_60->Divide(num_60,denom,1,1,"B");
    r_80->Divide(num_80,denom,1,1,"B");
    r_100->Divide(num_100,denom,1,1,"B");
    r_120->Divide(num_120,denom,1,1,"B");

    r_40->SetLineColor(kGray);
    r_60->SetLineColor(kRed);
    r_80->SetLineColor(kBlue);
    r_100->SetLineColor(kGreen);
    r_120->SetLineColor(kMagenta);

    r_40->SetMarkerColor(kGray);
    r_60->SetMarkerColor(kRed);
    r_80->SetMarkerColor(kBlue);
    r_100->SetMarkerColor(kGreen);
    r_120->SetMarkerColor(kMagenta);

    r_40->SetMarkerStyle(23);
    r_60->SetMarkerStyle(24);
    r_80->SetMarkerStyle(25);
    r_100->SetMarkerStyle(26);
    r_120->SetMarkerStyle(32);

    TCanvas *c1 = new TCanvas("c1","c1",700,600);
    c1->cd();
    TPad *p1 = new TPad("p1","p1",0,0,1,1);
    p1->SetLeftMargin(0.13);
    p1->SetBottomMargin(0.14);
    p1->Draw();
    p1->cd();
    r_60->SetTitle("");
    r_60->SetStats(0);
    r_60->GetXaxis()->SetTitleSize(0.05);
    r_60->GetYaxis()->SetTitleSize(0.05);
    r_60->GetXaxis()->SetTitle("leading jet #font[52]{p}_{T} [GeV]");
    r_60->GetYaxis()->SetTitle("Trigger efficiency");
    TLegend *leg = new TLegend(0.55,0.3,0.88,0.5);
    leg->AddEntry(r_40,"HLT_AK4PFJet40");
    leg->AddEntry(r_60,"HLT_AK4PFJet60");
    leg->AddEntry(r_80,"HLT_AK4PFJet80");
    leg->AddEntry(r_100,"HLT_AK4PFJet100");
    leg->AddEntry(r_120,"HLT_AK4PFJet120");
    //leg->SetBorderSize(0);
    r_60->Draw();
    leg->Draw();
    r_80->Draw("same");
    r_100->Draw("same");
    r_120->Draw("same");
    r_40->Draw("same");

    TLatex *la = new TLatex();
    la->SetTextFont(42);
    la->SetTextSize(0.03);

    la->DrawLatexNDC(0.6,0.75,"PYTHIA");
    la->DrawLatexNDC(0.6,0.69,"Run 3 MC");
    la->DrawLatexNDC(0.6,0.63,"|#eta^{jet}| < 1.5");

 


    auto wf = TFile::Open(outputFile.c_str(),"recreate");

    denom->Write();

    denomEta_40->Write();
    denomEta_60->Write();
    denomEta_80->Write();
    denomEta_100->Write();
    denomEta_120->Write();

    denomPhi_40->Write();
    denomPhi_60->Write();
    denomPhi_80->Write();
    denomPhi_100->Write();
    denomPhi_120->Write();

    num_40->Write();
    num_60->Write();
    num_80->Write();
    num_100->Write();
    num_120->Write();

    numEta_40->Write();
    numEta_60->Write();
    numEta_80->Write();
    numEta_100->Write();
    numEta_120->Write();

    numPhi_40->Write();
    numPhi_60->Write();
    numPhi_80->Write();
    numPhi_100->Write();
    numPhi_120->Write();

    r_40->Write();
    r_60->Write();
    r_80->Write();
    r_100->Write();
    r_120->Write();

    h_dr->Write();
    H_hlt_forest_pt->Write();

    wf->Close();

		     

}


